const web3 = require('../../web3');
const ABI = require('../constants/abis');

class PlayerService {
    
    async getPlayerInfo(address) {
        const contract = new web3.eth.Contract(ABI.player_abi, address)

        return await contract.methods.player().call()
        .then(response => {
            return response;
        })
        .catch(error => {
            throw error;
        })
    }

    async getPlayers() {
        const registry = new web3.eth.Contract(ABI.registry_abi, "0xE417B8038d1bB2D6F0FcB89817eF217f0180b81D")
        
        return await registry.methods.getPlayersForAddress(web3.eth.defaultAccount).call()
        .then(response => {
            return response;
        })
        .catch(error => {
            throw error;
        })
    }

    async getListedPlayers() {
        const registry = new web3.eth.Contract(ABI.registry_abi, "0xE417B8038d1bB2D6F0FcB89817eF217f0180b81D")
        
        return await registry.methods.getListedPlayers().call()
        .then(response => {
            return response;
        })
        .catch(error => {
            throw error;
        })
    }

    async createPlayer(player, player_price) {

        const contract = new web3.eth.Contract(ABI.player_abi, null, {
            gas: 3000000
        })

        return await contract.deploy({
            data: '608060405273e417b8038d1bb2d6f0fcb89817ef217f0180b81d6000806101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff1602179055506000809054906101000a900473ffffffffffffffffffffffffffffffffffffffff16600160006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff1602179055506040516200122f3803806200122f83398181016040526060811015620000df57600080fd5b81019080805160405193929190846401000000008211156200010057600080fd5b838201915060208201858111156200011757600080fd5b82518660018202830111640100000000821117156200013557600080fd5b8083526020830192505050908051906020019080838360005b838110156200016b5780820151818401526020810190506200014e565b50505050905090810190601f168015620001995780820380516001836020036101000a031916815260200191505b5060405260200180519060200190929190805190602001909291905050503481662386f26fc1000081028210156200021d576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004018080602001828103825260238152602001806200120c6023913960400191505060405180910390fd5b8460026000019080519060200190620002389291906200040d565b50836002600101819055508260028001819055506000600260030160006101000a81548160ff02191690831515021790555033600260030160016101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff1602179055503073ffffffffffffffffffffffffffffffffffffffff163160026004018190555030600260050160006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff160217905550600160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff166302a5452133306040518363ffffffff1660e01b8152600401808373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020018273ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200192505050600060405180830381600087803b158015620003e957600080fd5b505af1158015620003fe573d6000803e3d6000fd5b505050505050505050620004bc565b828054600181600116156101000203166002900490600052602060002090601f016020900481019282601f106200045057805160ff191683800117855562000481565b8280016001018555821562000481579182015b828111156200048057825182559160200191906001019062000463565b5b50905062000490919062000494565b5090565b620004b991905b80821115620004b55760008160009055506001016200049b565b5090565b90565b610d4080620004cc6000396000f3fe60806040526004361061003f5760003560e01c806348db5f891461004457806349f22cd81461015a5780637348c0c014610164578063f2f937901461017b575b600080fd5b34801561005057600080fd5b50610059610192565b6040518080602001888152602001878152602001861515151581526020018573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020018481526020018373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001828103825289818151815260200191508051906020019080838360005b838110156101195780820151818401526020810190506100fe565b50505050905090810190601f1680156101465780820380516001836020036101000a031916815260200191505b509850505050505050505060405180910390f35b6101626102a7565b005b34801561017057600080fd5b506101796106b0565b005b34801561018757600080fd5b506101906109ca565b005b6002806000018054600181600116156101000203166002900480601f01602080910402602001604051908101604052809291908181526020018280546001816001161561010002031660029004801561022c5780601f106102015761010080835404028352916020019161022c565b820191906000526020600020905b81548152906001019060200180831161020f57829003601f168201915b5050505050908060010154908060020154908060030160009054906101000a900460ff16908060030160019054906101000a900473ffffffffffffffffffffffffffffffffffffffff16908060040154908060050160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff16905087565b338073ffffffffffffffffffffffffffffffffffffffff16600260030160019054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16141561036f576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040180806020018281038252601a8152602001807f596f7520646f206e6f74206f776e207468697320706c6179657200000000000081525060200191505060405180910390fd5b60011515600260030160009054906101000a900460ff161515146103fb576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004018080602001828103825260188152602001807f54686520706c61796572206973206e6f74206c6973746564000000000000000081525060200191505060405180910390fd5b34600260040154811015610477576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004018080602001828103825260208152602001807f496e73756666696369656e742066756e647320746f2062757920706c6179657281525060200191505060405180910390fd5b600260030160019054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff166108fc60023073ffffffffffffffffffffffffffffffffffffffff1631816104d757fe5b049081150290604051600060405180830381858888f19350505050158015610503573d6000803e3d6000fd5b50600160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1663fd014d59600260030160019054906101000a900473ffffffffffffffffffffffffffffffffffffffff1633306040518463ffffffff1660e01b8152600401808473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020018373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020018273ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019350505050600060405180830381600087803b15801561063257600080fd5b505af1158015610646573d6000803e3d6000fd5b5050505033600260030160016101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff1602179055506000600260030160006101000a81548160ff0219169083151502179055505050565b338073ffffffffffffffffffffffffffffffffffffffff16600260030160019054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1614610777576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040180806020018281038252601b8152602001807f596f7520616c7265616479206f776e207468697320706c61796572000000000081525060200191505060405180910390fd5b60011515600260030160009054906101000a900460ff16151514610803576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004018080602001828103825260188152602001807f54686520706c61796572206973206e6f74206c6973746564000000000000000081525060200191505060405180910390fd5b6000600260030160006101000a81548160ff021916908315150217905550600160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff166328b0e4cc306040518263ffffffff1660e01b8152600401808273ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001915050600060405180830381600087803b1580156108c257600080fd5b505af11580156108d6573d6000803e3d6000fd5b50505050600160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16638e3d63c633306040518363ffffffff1660e01b8152600401808373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020018273ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200192505050600060405180830381600087803b1580156109af57600080fd5b505af11580156109c3573d6000803e3d6000fd5b5050505050565b338073ffffffffffffffffffffffffffffffffffffffff16600260030160019054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1614610a91576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040180806020018281038252601b8152602001807f596f7520616c7265616479206f776e207468697320706c61796572000000000081525060200191505060405180910390fd5b60001515600260030160009054906101000a900460ff16151514610b1d576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040180806020018281038252601c8152602001807f54686520706c6179657220697320616c7265616479206c69737465640000000081525060200191505060405180910390fd5b6001600260030160006101000a81548160ff021916908315150217905550600160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1663d07c8575306040518263ffffffff1660e01b8152600401808273ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001915050600060405180830381600087803b158015610bdc57600080fd5b505af1158015610bf0573d6000803e3d6000fd5b50505050600160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1663f4987b7533306040518363ffffffff1660e01b8152600401808373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020018273ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200192505050600060405180830381600087803b158015610cc957600080fd5b505af1158015610cdd573d6000803e3d6000fd5b505050505056fea265627a7a7231582072dfbe8f9c10a63eb5a5aa473ac1116dd9b4b8d1dd5c150125df945bc22c01f764736f6c637829302e352e31332d6e696768746c792e323031392e31302e32332b636f6d6d69742e65353664316161350059496e73756666696369656e742066756e647320746f2063726561746520706c61796572',
            arguments: [player.name, player.pos, player.overall]
        })
        .send({
            from: web3.eth.defaultAccount,
            value: player_price
        })
        .then((response) => {
            return response;
        })
        .catch(error => {
            throw error;
        })
    }

    async listPlayer(address) {
        const contract = new web3.eth.Contract(ABI.player_abi, address)

        console.log(contract)
        return await contract.methods.listPlayer().send({
            from: web3.eth.defaultAccount,
            gas: 3000000
        })
        .then(response => {
            console.log(response)
            return response;
        })
        .catch(error => {
            throw error;
        })
    }

    async unlistPlayer(address) {
        const contract = new web3.eth.Contract(ABI.player_abi, address)

        console.log(contract)
        return await contract.methods.unlistPlayer().send({
            from: web3.eth.defaultAccount,
            gas: 3000000
        })
        .then(response => {
            console.log(response)
            return response;
        })
        .catch(error => {
            throw error;
        })
    }
}

module.exports = new PlayerService()